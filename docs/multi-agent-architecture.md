# 多Agent分层响应架构 - 实现文档 (v2.0)

**版本**: 2.0  
**日期**: 2026-02-27  
**作者**: OpenClaw Agent (E0)  
**状态**: 已更新，参考 Google ADK 架构

---

## 一、架构设计

### 1.1 核心参考：Google ADK
- **分层上下文架构** (tiered context)
- **多Agent上下文作用域** (multi-agent context scoping)
- 生产级验证，成熟度高

### 1.2 我们的实现
```
用户消息 → 主Agent(E0)
    ├── 简单(评分≤2) → 立即回复
    ├── 中等(评分3-5) → E1/E2 子Agent处理
    └── 复杂(评分>5) → 后台子Agent池
```

### 1.3 设计目标
1. **对话流畅性**: 简单查询立即响应（<2秒）
2. **后台处理**: 耗时任务不阻塞主对话
3. **资源可控**: 限制并发子Agent数量
4. **上下文隔离**: 每个Agent独立上下文

---

## 二、2秒阈值（优于行业标准）

### 2.1 行业标准
- 2024年聊天机器人标准响应时间：**< 1秒**
- Google ADK：50-200ms常规，复杂验证可增至500ms+

### 2.2 我们为什么用2秒
- 比1秒更实用，给LLM思考余地
- 用户感知"流畅"的心理阈值
- 简单任务仍快，复杂任务有缓冲

---

## 三、复杂度评分机制

### 3.1 评分因素
| 因素 | 权重 | 说明 |
|------|------|------|
| 消息长度 | +2 | 长文本（>100字）需要更多处理 |
| 快速关键词 | -2 | "你好"/"测试"等简单查询 |
| 耗时关键词 | +3 | "抓取"/"分析"/"批量"等 |
| 数字量词 | +3 | "100张"/"所有"/"批量" |
| 文件操作 | +2 | 涉及代码/文件处理 |

### 3.2 评分阈值
| 分数 | 决策 | 预估时间 |
|------|------|----------|
| 0-2 | 立即回复 | <500ms |
| 3-5 | 快速回复 | <2s |
| >5 | 子Agent处理 | >2s |

### 3.3 测试案例
| 消息 | 评分 | 决策 |
|------|------|------|
| "你好，测试一下" | 0 | 立即回复 |
| "查询当前状态" | 2 | 立即回复 |
| "分析这个日志文件" | 7 | 子Agent |
| "抓取汽车之家100张图片" | 10 | 子Agent |

---

## 四、Agent 角色分配

| Agent | 角色 | 职责 |
|-------|------|------|
| **E0** | 主Agent | 消息路由、简单响应、任务分配 |
| **E1** | 程序员 | 代码开发、文件处理、技术任务 |
| **E2** | 待分配 | 扩展角色 |

---

## 五、实现方式

### 5.1 配置参数
```javascript
const CONFIG = {
  RESPONSE_THRESHOLD_MS: 2000,    // 2秒阈值
  MAX_SUBAGENTS: 4,               // 最大并发子Agent
  SUBAGENT_TIMEOUT_SECONDS: 300,  // 子Agent超时
  SCORE_IMMEDIATE: 2,             // 立即回复阈值
  SCORE_FAST: 5                   // 快速回复阈值
};
```

### 5.2 核心组件
1. **复杂度评分器** - 分析消息复杂度
2. **路由器** - 根据评分分配任务
3. **子Agent池** - 管理后台任务

---

## 六、风险与缓解

### 6.1 风险
- 误判为耗时任务 → 资源浪费
- 误判为简单任务 → 主Agent卡顿
- 子Agent池满 → 任务排队

### 6.2 缓解措施
- 渐进式启用（观察模式 → 白名单 → 全量）
- 用户可手动说"后台执行"强制分配

---

## 七、后续行动

- [ ] 观察模式测试
- [ ] 白名单关键词验证
- [ ] 集成 Google ADK 思想优化上下文管理

---

**更新者**: E0 Agent  
**更新时间**: 2026-02-27 13:20
